---
title: "Assignment 5.1: Data Storytelling with Shiny"
author: "April Chia"
format: html
runtime: shiny
---


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(shiny)
library(fpp3)
library(tidyverse)
library(gt)
```

## Load and Wrangle

```{r}
# Read CSV → tsibble with index = Month, key = Varietal
aus_wine <- read_csv(here::here("AustralianWines.csv"), na = "*",
                     col_types = cols(Rose = col_number()),
                     show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) 
aus_wine <- aus_wine |>
    pivot_longer(cols = -Month, names_to = "Varietal", values_to = "Sales") |> 
    as_tsibble(index = Month, key = Varietal)

# Filter by inputs: varietal(s), date range.
min_date <- as.Date(min(aus_wine$Month))
max_date <- as.Date(max(aus_wine$Month))
```

## Split

```{r}
# Training/validation split
train_end <- yearmonth("1993 Dec")
training <- aus_wine |> filter(Month <= train_end)
validation <- aus_wine |> filter(Month > train_end)
```

## Model (per varietal)

```{r}
# Fit models to training data
wine_models <- training |>
  model(
    TSLM = TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales)
  )
```

## Forecast

```{r}
# Forecast using forecast(h = input$h) and also generate forecasts over the validation window for scoring.
wine_forecasts <- wine_models |>
  forecast(h = "12 months")
```

## Evaluate, Visualize, Document

```{r}
# UI controls and placeholders (rendered in document)
selectInput(
  "varietal_select", "Select varietal(s):",
  choices = sort(unique(aus_wine$Varietal)),
  selected = unique(aus_wine$Varietal)[1],
  multiple = TRUE
)

dateRangeInput(
  "date_range", "Date range:",
  start = min_date, end = max_date,
  min = min_date, max = max_date,
  format = "yyyy-mm"
)

# placeholders for plots
plotOutput("overview_plot", height = "420px")
plotOutput("season_plot", height = "420px")
```

```{r context="server"}
output$overview_plot <- renderPlot({
  req(input$varietal_select)
  filtered <- aus_wine |>
    filter(
      Varietal %in% input$varietal_select,
      Month >= yearmonth(input$date_range[1]),
      Month <= yearmonth(input$date_range[2])
    )

  ggplot(filtered, aes(x = Month, y = Sales, color = Varietal, group = Varietal)) +
    geom_line(size = 0.8) +
    geom_point(size = 0.9, alpha = 0.7) +
    labs(title = "Wine sales — time series overview",
         x = "Month", y = "Sales") +
    theme_minimal() +
    theme(legend.position = "bottom")
})

output$season_plot <- renderPlot({
  req(input$varietal_select)
  filtered <- aus_wine |>
    filter(
      Varietal %in% input$varietal_select,
      Month >= yearmonth(input$date_range[1]),
      Month <= yearmonth(input$date_range[2])
    )

  # If multiple varietals selected, facet by varietal; otherwise single-panel seasonal plot
  if (length(unique(filtered$Varietal)) > 1) {
    gg_season(filtered, Sales) +
      facet_wrap(vars(Varietal), scales = "free_y") +
      labs(title = "Seasonal pattern by varietal", y = "Sales") +
      theme_minimal()
  } else {
    gg_season(filtered, Sales) +
      labs(title = paste("Seasonality —", unique(filtered$Varietal)), y = "Sales") +
      theme_minimal()
  }
})
```
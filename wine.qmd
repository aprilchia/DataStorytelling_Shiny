---
title: "Australian Wine Sales Forecast"
format: html
---


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(tidyverse)
library(gt)
```

## Tab 1 - Overview Plot

### Load and Wrangle

* Inputs - varietal selection
* Date range selection

```{r}
# Read CSV â†’ tsibble with index = Month, key = Varietal
aus_wine <- read_csv(here::here("AustralianWines.csv"), na = "*",
                     col_types = cols(Rose = col_number()),
                     show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) 
aus_wine <- aus_wine |>
    pivot_longer(cols = -Month, names_to = "Varietal", values_to = "Sales") |> 
    as_tsibble(index = Month, key = Varietal)

# Filter by inputs: varietal(s), date range.
max_date <- max(aus_wine$Month)
min_date <- min(aus_wine$Month)

filtered_data <- aus_wine %>%
  filter(
    Varietal %in% c("Fortified", "Red", "Rose", "sparkling", "Sweet white", "Dry white"),
    Month >= min_date,
    Month <= max_date
  )
```

### Split

```{r}
# Training/validation split
train_end <- yearmonth("1993 Dec")

training <- aus_wine |> filter(Month <= train_end)
validation <- aus_wine |> filter(Month > train_end)
```

### Data Visualization

```{r}
aus_wine |>
    autoplot(Sales) +
    geom_vline(xintercept = train_end, linetype = "dashed") +
    labs(y = "Sales", title = "Australian Wine Sales by Varietal") +
    facet_wrap(~ Varietal, ncol = 1, scales = "free_y") +
    theme_minimal()
```

## Tab 2 - Modeling

### Model (per varietal)

Inputs:

* Toggle for model types to include TSLM, ETS, and ARIMA (default off)
* Toggle training accuracy (default off)

```{r}
# Fit models to training data
wine_models <- training |>
  model(
    TSLM = TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales)
  )

wine_models
```

### Forecast

```{r}
# Forecast on validation period
wine_fc <- wine_models %>%
  forecast(h = 12)

# Forecast over validation window
validation_fc <- wine_models %>%
  forecast(new_data = validation)
```

### Evaluate

```{r}
# Training accuracy
wine_models |>
    accuracy() |>
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(.model, RMSE) |>
    gt() |> fmt_number(
      columns = c(RMSE, MAE, MAPE),
      decimals = 2
    )
```
```{r}
# Forecast accuracy
wine_fc |>
    accuracy(aus_wine) |>
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(.model, RMSE) |>
    gt() |> fmt_number(
      columns = c(RMSE, MAE, MAPE),
      decimals = 2
    )
```

## Tab 3 - Forecast 

Inputs:

* Users can select which model to use for forecast table

### Visualize Forecast

```{r}
cut_off <- yearmonth(min_date |> as.Date() + years(8))
wine_fc |>
    autoplot(aus_wine |> filter(Month >= cut_off)) +
    labs(title = "Forecasted Wine Sales by Varietal", x = "Month", y = "Sales") +
    facet_wrap(~ Varietal, scales = "free_y")
```

### Forecast Table

```{r}
final_fc <- wine_fc |>
  as_tibble() |> 
  filter(.model == "ETS") |>
  select(Month, Varietal, .mean) |>
  mutate(.mean = map_dbl(.mean, as.numeric)) |>
  pivot_wider(names_from = Varietal, values_from = .mean) |>
  arrange(Month) |>
  gt() |>
  fmt_number(
    decimals = 0
  )

final_fc
```
